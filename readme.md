# Бутлодер совместимых с КТРЦ платформ

* Проверка бутлодера **(Подсчёт контрольной суммы)**
* Проверка прошивки перед запуском **(Подсчёт контрольной суммы)**
* Прошивка неограниченного количества модулей подключённых к 2-ум шинам CAN **(Системный А + Системный Б)**
* Поддержка нескольких типов модулей:
  * **КУ** - Контроллер управления
  * **МПП** - Модуль - путевой приёмник
  * **ГКС** - Генератор комплексных сигналов
  * **КТРЦ** - Контроллер тональных рельсовых цепей
  * **МЭЦ** - Модуль электрической централизации
  * **КС** - Контроллер связи



## Зависимости

* **cmake 3.16+**  
* **gcc-arm-none-eabi 9.2+**
* **openocd 0.10+**
* **python 3.8+**



## Компиляция

```shell
sh build.sh -m [module_type]
```


## Запись бутлодера

```shell
sh prog-btl.sh -m [module_type] -i [interface]
```

`module_type`: [`cu`, `mpp`, `gks`, `ktrc`, `mec`]

`interface:`: [`stlink`, `jlink`]



## Прошивка через бутлодер


```shell
python3 ./utils/btl_loader.py [firmware_path] --module-type [module_type] --can-a [can_a] --can-b [can_b] --force
```

`firmware_path` - путь до файла прошивки формата `.elf`

`--module-type [module_type]` - Тип модуля. Список типов модулей: `[cu, mpp, gks, ktrc, mec]`

`--can-a [can_a]` - CAN интерфейс в системе, подключённый к каналу модуля CAN А.

`--can-b [can_b]` - CAN интерфейс в системе, подключённый к каналу модуля CAN Б.

`--force` - Принудительная прошивка при совпадении контрольных сумм

Если прошивки для процессора А (канала А) и процессора Б (канала Б) отличаются - 
организация прошивки в два захода: с указанием только одного канала CAN.

```shell
python3 ./utils/btl_loader.py [firmware_a_path] --module-type [module_type] --can-a [can_a] --force
python3 ./utils/btl_loader.py [firmware_b_path] --module-type [module_type] --can-b [can_b] --force
```


## Прошивка
Прежде чем прошить через бутлодер - нужно переконфигурировать проект прошивки и перекомпилировать его.  

В скрипте компоновки прошивки необходимо изменить адрес начала флеш памяти  

**Изначальный вид:**
```text
MEMORY
{
  RAM    (xrw) : ORIGIN = 0x20000000,   LENGTH = 128K
  FLASH  (rx)  : ORIGIN = 0x8000000,    LENGTH = 1024K
}
```

**Смещение адреса начала флеш памяти**
```text
MEMORY
{
  RAM    (xrw) : ORIGIN = 0x20000000,   LENGTH = 128K
  FLASH  (rx)  : ORIGIN = 0x8008000,    LENGTH = 992K
}
```



## Протокол

### Структура ID CAN сообщения
```c
typedef struct {
    uint32_t    interface   :3;   ///< Интерфейс (системный А - канал А, системный Б - канал Б)
    uint32_t    number      :8;   ///< Номер модуля (=0)
    uint32_t    command     :9;   ///< Номер команды
    uint32_t    type        :9;   ///< Тип модуля
    uint32_t                :3;   ///< Заголовок 29 бит - 3 бита от uint32_t не используются
} abtci_protocol_header;
```

### Команды 
```c
typedef enum {
/// Команды информирования
    sys_cmd_btl_inf                 = 10,   ///< Информация бутлодера
    sys_cmd_btl_damaged             = 11,   ///< Бутлодер неисправен
    sys_cmd_btl_fw_damaged          = 17,   ///< Прошивка повреждена (Ошибка контрольной суммы)
    sys_cmd_btl_safe_cell_fault     = 19,   ///< Повреждение ячейки безопасности (Отсутствуют прерывания)
    sys_cmd_btl_wrong_msg           = 12,   ///< Неправильное сообщение (Неверная длина данных)
    sys_cmd_blt_fw_run              = 18,   ///< Запуск прошивки
    sys_cmd_btl_no_space_available  = 13,   ///< Нет свободного места
// Команды управления
    sys_cmd_btl_erase               = 20,   ///< Удаление прошивки
    sys_cmd_btl_flash               = 21,   ///< Блок прошивки
    sys_cmd_btl_request             = 22,   ///< Запрос блока прошивки
    sys_cmd_btl_force_run           = 23,   ///< Принудительный запуск (После процесса перепрошивки или при повреждённой прошивке)
} sys_cmd_btl;
```


### Структуры данных
#### Тип 24-битного без знакового значения
Формат значения - big-endian (network) - где b[0] - старший байт значения, а b[2] - младший байт значения
```c
typedef struct {
	uint8_t b[3];
} def24_t;
```

#### Структура данных сообщения "Удаление прошивки"
```c
typedef struct {
    uint32_t    key;        ///< Любое 32-ух битное число
    uint32_t    nkey;       ///< Инвертированное значение 'key' (с применением побитового НЕ)
} sys_cmd_btl_inf_erase;
```

#### Структура данных сообщения "Информация бутлодера"
```c
typedef struct {
    uint8_t     version;    ///< Версия бутлодера
    def24_t     size;       ///< Размер прошивки (максимум 16 мегабайт!)
    uint32_t    checksum;   ///< Контрольная сумма прошивки (crc32)
} sys_cmd_btl_inf_data;
```

#### Структура данных сообщения "Блок прошивки"
```c
typedef struct {
    uint8_t     checksum    ///< Контрольная сумма (crc8)
    def24_t     number;     ///< Номер передаваемого блока (ограничение - 4194304 блоков (16 мегабайт))
    uint8_t     data[4];    ///< 4 байта данных (кратно uint32 для записи целого слова, во избежание проблем на некоторых архитектурах)
} sys_cmd_btl_flash_data;
```


#### Структура данных сообщения "Запрос блока данных"
```c
typedef struct {
    def24_t     number;     ///< Номер запрашиваемого блока
} sys_cmd_btl_request_data;
```



## Описание работы

* Проверка контрольной суммы бутлодера
  * ок - Далее
  * ошибка - Отправка CAN сообщения **[команда: `sys_cmd_btl_damaged`]**, поднятие флага `BTL_STUCK`
* Проверка контрольной суммы прошивки
  * ок - Далее
  * ошибка - Отправка CAN сообщения **[команда: `sys_cmd_btl_fw_damaged`]**, поднятие флага `BTL_STUCK`
* `[1]`
* Отправка CAN сообщения **[команда: `sys_cmd_btl_inf`]** с версией бутлодера, контрольной суммой и размером прошивки
* Ожидание **3** секунды для входящих сообщений
  * Сообщение пришло 
    * Входящее сообщение: **[команда: `sys_cmd_btl_erase`]**
      * Запуск процесса прошивки
      * Поднятие флага `BTL_STUCK`
      * Очистка флеш памяти
      * Запрос блока прошивки под номером **0** - Отправка CAN сообщения **[команда: `sys_cmd_btl_request`]**
    * Входящее сообщение: **[команда: `sys_cmd_btl_flash`]**
      * Процесс прошивки не запущен -> Игнорирование
      * Номер блока прошивки больше, чем ожидаемый -> Запрос блока прошивки под нужным номером - Отправка CAN сообщения **[команда: `sys_cmd_btl_request`]**
      * Номер блока прошивки меньше, чем ожидаемый -> Игнорирование
      * Номер блока прошивки равен ожидаемому
        * Размер данных блока прошивки больше 0 байт -> Запись в флеш
        * Размер данных блока прошивки равен 0 -> Подсчёт КС записанной прошивки, сохранение КС и размера в флеша 
    * Входящее сообщение: **[команда: `sys_cmd_btl_force_run`]**
      * Процесс прошивки не запущен -> Сброс флага `BTL_STUCK`
    * Таймаут получения сообщений
      * Запущен процесс прошивки -> запрос блока прошивки под нужным номером 
* **3** секунды прошло
  * Запущен процесс прошивки -> Ожидание завершения процесса прошивки
  * Поднят флаг `BTL_STUCK` -> возврат в `[1]`
* Отправка CAN сообщения **[команда: `sys_cmd_blt_fw_run`]**